openapi: 3.1.0
info:
  title: Chat API
  version: 0.1.0
  description: |
    MVP API for auth, model discovery, chat persistence, and SSE streaming responses.
servers:
  - url: https://api.chat.sanetomore.com
    description: Production
  - url: http://localhost:8080
    description: Local
paths:
  /health:
    get:
      summary: Health check (Cloud Run-safe path)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    example: ok
  /healthz:
    get:
      summary: Health check (local compatibility)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    example: ok
  /v1/auth/google:
    post:
      summary: Exchange Google ID token for a session cookie
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [idToken]
              properties:
                idToken:
                  type: string
      responses:
        '200':
          description: Authenticated
          headers:
            Set-Cookie:
              schema:
                type: string
              description: HTTP-only session cookie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Error'
        '403':
          $ref: '#/components/responses/Error'
  /v1/auth/me:
    get:
      summary: Current authenticated user
      security:
        - SessionCookie: []
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Error'
  /v1/auth/logout:
    post:
      summary: Revoke current session cookie
      security:
        - SessionCookie: []
      responses:
        '200':
          description: Session revoked
          content:
            application/json:
              schema:
                type: object
                required: [success]
                properties:
                  success:
                    type: boolean
                    example: true
        '401':
          $ref: '#/components/responses/Error'
  /v1/models:
    get:
      summary: List model options
      security:
        - SessionCookie: []
      responses:
        '200':
          description: Available models
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListModelsResponse'
        '401':
          $ref: '#/components/responses/Error'
  /v1/models/sync:
    post:
      summary: Manually sync model catalog from OpenRouter into local cache
      security:
        - ModelSyncBearer: []
      responses:
        '200':
          description: Catalog sync completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncModelsResponse'
        '401':
          $ref: '#/components/responses/Error'
        '503':
          $ref: '#/components/responses/Error'
        '502':
          $ref: '#/components/responses/Error'
  /v1/models/preferences:
    put:
      summary: Update model preference for chat or deep research mode
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateModelPreferencesRequest'
      responses:
        '200':
          description: Updated model preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateModelPreferencesResponse'
        '400':
          $ref: '#/components/responses/Error'
        '401':
          $ref: '#/components/responses/Error'
  /v1/models/favorites:
    put:
      summary: Add or remove a model favorite for the current user
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateModelFavoriteRequest'
      responses:
        '200':
          description: Updated favorite model ids
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateModelFavoriteResponse'
        '400':
          $ref: '#/components/responses/Error'
        '401':
          $ref: '#/components/responses/Error'
  /v1/models/reasoning-presets:
    put:
      summary: Update reasoning effort preset for a model and mode
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateReasoningPresetRequest'
      responses:
        '200':
          description: Updated reasoning presets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateReasoningPresetResponse'
        '400':
          $ref: '#/components/responses/Error'
        '401':
          $ref: '#/components/responses/Error'
  /v1/files:
    post:
      summary: Upload one attachment file
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '201':
          description: File uploaded and indexed for prompt usage
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadFileResponse'
        '400':
          $ref: '#/components/responses/Error'
        '401':
          $ref: '#/components/responses/Error'
        '413':
          $ref: '#/components/responses/Error'
        '503':
          $ref: '#/components/responses/Error'
  /v1/conversations:
    post:
      summary: Create a conversation
      security:
        - SessionCookie: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
      responses:
        '201':
          description: Conversation created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateConversationResponse'
        '400':
          $ref: '#/components/responses/Error'
        '401':
          $ref: '#/components/responses/Error'
    get:
      summary: List conversations for the current user
      security:
        - SessionCookie: []
      responses:
        '200':
          description: Conversations ordered by recent activity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListConversationsResponse'
        '401':
          $ref: '#/components/responses/Error'
    delete:
      summary: Delete all conversations for the current user
      security:
        - SessionCookie: []
      responses:
        '200':
          description: Conversations deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'
        '401':
          $ref: '#/components/responses/Error'
  /v1/conversations/{id}:
    delete:
      summary: Delete one conversation for the current user
      security:
        - SessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Conversation deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'
        '401':
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/Error'
  /v1/conversations/{id}/messages:
    get:
      summary: List messages for a conversation
      security:
        - SessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Messages in chronological order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMessagesResponse'
        '401':
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/Error'
  /v1/chat/messages:
    post:
      summary: Send a chat message and stream assistant tokens (SSE)
      security:
        - SessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatMessageRequest'
      responses:
        '200':
          description: SSE stream of assistant output events
          content:
            text/event-stream:
              schema:
                type: string
                description: SSE events with `event: message` and JSON payload in `data:`. Event types include `metadata`, `progress`, `warning`, `token`, `reasoning`, `usage`, `citations`, `error`, and `done`.
        '400':
          $ref: '#/components/responses/Error'
        '401':
          $ref: '#/components/responses/Error'
        '404':
          $ref: '#/components/responses/Error'
components:
  securitySchemes:
    SessionCookie:
      type: apiKey
      in: cookie
      name: chat_session
    ModelSyncBearer:
      type: http
      scheme: bearer
      bearerFormat: token
  responses:
    Error:
      description: Error envelope
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
  schemas:
    User:
      type: object
      required: [id, email, googleSub, createdAt, updatedAt]
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        name:
          type: string
        avatarUrl:
          type: string
        googleSub:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    AuthResponse:
      type: object
      required: [user]
      properties:
        user:
          $ref: '#/components/schemas/User'
    Model:
      type: object
      required:
        [id, name, provider, contextWindow, promptPriceMicrosUsd, outputPriceMicrosUsd, supportsReasoning, curated]
      properties:
        id:
          type: string
        name:
          type: string
        provider:
          type: string
        contextWindow:
          type: integer
        promptPriceMicrosUsd:
          type: integer
        outputPriceMicrosUsd:
          type: integer
        supportsReasoning:
          type: boolean
        curated:
          type: boolean
    ReasoningEffort:
      type: string
      enum: [low, medium, high]
    ReasoningPreset:
      type: object
      required: [modelId, mode, effort]
      properties:
        modelId:
          type: string
        mode:
          type: string
          enum: [chat, deep_research]
        effort:
          $ref: '#/components/schemas/ReasoningEffort'
    ModelPreferences:
      type: object
      required: [lastUsedModelId, lastUsedDeepResearchModelId]
      properties:
        lastUsedModelId:
          type: string
        lastUsedDeepResearchModelId:
          type: string
    ListModelsResponse:
      type: object
      required: [models, curatedModels, favorites, preferences, reasoningPresets]
      properties:
        models:
          type: array
          items:
            $ref: '#/components/schemas/Model'
        curatedModels:
          type: array
          items:
            $ref: '#/components/schemas/Model'
        favorites:
          type: array
          items:
            type: string
        preferences:
          $ref: '#/components/schemas/ModelPreferences'
        reasoningPresets:
          type: array
          items:
            $ref: '#/components/schemas/ReasoningPreset'
    SyncModelsResponse:
      type: object
      required: [synced]
      properties:
        synced:
          type: integer
          minimum: 0
    UpdateModelPreferencesRequest:
      type: object
      required: [mode, modelId]
      properties:
        mode:
          type: string
          enum: [chat, deep_research]
        modelId:
          type: string
    UpdateModelPreferencesResponse:
      type: object
      required: [preferences]
      properties:
        preferences:
          $ref: '#/components/schemas/ModelPreferences'
    UpdateModelFavoriteRequest:
      type: object
      required: [modelId, favorite]
      properties:
        modelId:
          type: string
        favorite:
          type: boolean
    UpdateModelFavoriteResponse:
      type: object
      required: [favorites]
      properties:
        favorites:
          type: array
          items:
            type: string
    UpdateReasoningPresetRequest:
      type: object
      required: [modelId, mode, effort]
      properties:
        modelId:
          type: string
        mode:
          type: string
          enum: [chat, deep_research]
        effort:
          $ref: '#/components/schemas/ReasoningEffort'
    UpdateReasoningPresetResponse:
      type: object
      required: [reasoningPresets]
      properties:
        reasoningPresets:
          type: array
          items:
            $ref: '#/components/schemas/ReasoningPreset'
    Conversation:
      type: object
      required: [id, title, createdAt, updatedAt]
      properties:
        id:
          type: string
        title:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    Message:
      type: object
      required:
        [id, conversationId, role, content, groundingEnabled, deepResearchEnabled, citations, createdAt]
      properties:
        id:
          type: string
        conversationId:
          type: string
        role:
          type: string
          enum: [system, user, assistant, tool]
        content:
          type: string
        modelId:
          type: string
          nullable: true
        usage:
          $ref: '#/components/schemas/Usage'
        groundingEnabled:
          type: boolean
        deepResearchEnabled:
          type: boolean
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
        createdAt:
          type: string
          format: date-time
    Citation:
      type: object
      required: [url]
      properties:
        url:
          type: string
          format: uri
        title:
          type: string
        snippet:
          type: string
        sourceProvider:
          type: string
    File:
      type: object
      required: [id, filename, mediaType, sizeBytes, createdAt]
      properties:
        id:
          type: string
        filename:
          type: string
        mediaType:
          type: string
        sizeBytes:
          type: integer
        createdAt:
          type: string
          format: date-time
    UploadFileResponse:
      type: object
      required: [file]
      properties:
        file:
          $ref: '#/components/schemas/File'
    CreateConversationRequest:
      type: object
      properties:
        title:
          type: string
    CreateConversationResponse:
      type: object
      required: [conversation]
      properties:
        conversation:
          $ref: '#/components/schemas/Conversation'
    ListConversationsResponse:
      type: object
      required: [conversations]
      properties:
        conversations:
          type: array
          items:
            $ref: '#/components/schemas/Conversation'
    ListMessagesResponse:
      type: object
      required: [messages]
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
    DeleteResponse:
      type: object
      required: [success]
      properties:
        success:
          type: boolean
          example: true
    ChatMessageRequest:
      type: object
      required: [message]
      properties:
        conversationId:
          type: string
          description: Existing conversation id. If omitted, the backend creates a new conversation.
        message:
          type: string
        modelId:
          type: string
        reasoningEffort:
          $ref: '#/components/schemas/ReasoningEffort'
        grounding:
          type: boolean
          default: true
        deepResearch:
          type: boolean
          default: false
        fileIds:
          type: array
          items:
            type: string
    StreamEvent:
      oneOf:
        - $ref: '#/components/schemas/StreamEventMetadata'
        - $ref: '#/components/schemas/StreamEventProgress'
        - $ref: '#/components/schemas/StreamEventWarning'
        - $ref: '#/components/schemas/StreamEventToken'
        - $ref: '#/components/schemas/StreamEventUsage'
        - $ref: '#/components/schemas/StreamEventCitations'
        - $ref: '#/components/schemas/StreamEventError'
        - $ref: '#/components/schemas/StreamEventDone'
      discriminator:
        propertyName: type
    Usage:
      type: object
      required: [promptTokens, completionTokens, totalTokens]
      properties:
        promptTokens:
          type: integer
          minimum: 0
        completionTokens:
          type: integer
          minimum: 0
        totalTokens:
          type: integer
          minimum: 0
        reasoningTokens:
          type: integer
          minimum: 0
        costMicrosUsd:
          type: integer
          minimum: 0
        byokInferenceCostMicrosUsd:
          type: integer
          minimum: 0
        tokensPerSecond:
          type: number
          minimum: 0
        modelId:
          type: string
        providerName:
          type: string
    StreamEventMetadata:
      type: object
      required: [type, grounding, deepResearch, modelId]
      properties:
        type:
          type: string
          enum: [metadata]
        grounding:
          type: boolean
        deepResearch:
          type: boolean
        modelId:
          type: string
        reasoningEffort:
          $ref: '#/components/schemas/ReasoningEffort'
        conversationId:
          type: string
    StreamEventProgress:
      type: object
      required: [type, phase]
      properties:
        type:
          type: string
          enum: [progress]
        phase:
          type: string
          enum: [planning, searching, synthesizing, finalizing]
        message:
          type: string
        pass:
          type: integer
          minimum: 0
        totalPasses:
          type: integer
          minimum: 0
    StreamEventWarning:
      type: object
      required: [type, scope, message]
      properties:
        type:
          type: string
          enum: [warning]
        scope:
          type: string
        message:
          type: string
    StreamEventToken:
      type: object
      required: [type, delta]
      properties:
        type:
          type: string
          enum: [token]
        delta:
          type: string
    StreamEventUsage:
      type: object
      required: [type, usage]
      properties:
        type:
          type: string
          enum: [usage]
        usage:
          $ref: '#/components/schemas/Usage'
    StreamEventCitations:
      type: object
      required: [type, citations]
      properties:
        type:
          type: string
          enum: [citations]
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
    StreamEventError:
      type: object
      required: [type, message]
      properties:
        type:
          type: string
          enum: [error]
        message:
          type: string
    StreamEventDone:
      type: object
      required: [type]
      properties:
        type:
          type: string
          enum: [done]
    ErrorEnvelope:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
