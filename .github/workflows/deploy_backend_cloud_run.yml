name: Deploy Backend Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-backend-cloud-run
  cancel-in-progress: false

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'chat-486915' }}
  REGION: ${{ vars.GCP_REGION || 'us-east1' }}
  SERVICE_NAME: ${{ vars.CLOUD_RUN_SERVICE || 'chat-backend' }}
  ARTIFACT_REGISTRY_REPO: ${{ vars.ARTIFACT_REGISTRY_REPOSITORY || 'cloud-run-source-deploy' }}
  IMAGE_NAME: ${{ vars.BACKEND_IMAGE_NAME || 'chat-backend' }}
  PLATFORM: linux/amd64
  ALLOW_UNAUTHENTICATED: ${{ vars.CLOUD_RUN_ALLOW_UNAUTHENTICATED || 'true' }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER || 'projects/1011074047731/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' }}
  DEPLOY_SERVICE_ACCOUNT: ${{ vars.GCP_DEPLOY_SERVICE_ACCOUNT || 'chat-backend-gha-deployer@chat-486915.iam.gserviceaccount.com' }}

jobs:
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@71f986410dfbc7added4569d411d040a91dc6935 # v2.1.8
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOY_SERVICE_ACCOUNT }}

      - name: Install gcloud SDK
        uses: google-github-actions/setup-gcloud@4111bea454dcfe1b4c2db3753685db043571e112 # v2.1.3

      - name: Enable Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Configure Docker auth for Artifact Registry
        run: |
          set -euo pipefail
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Build and push backend image
        id: image
        run: |
          set -euo pipefail

          short_sha="${GITHUB_SHA::7}"
          unique_tag="$(date -u +%Y%m%d-%H%M%S)-${short_sha}"
          sha_tag="sha-${short_sha}"
          latest_tag="latest"
          image_base="${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REGISTRY_REPO}/${IMAGE_NAME}"
          image_uri="${image_base}:${unique_tag}"

          docker buildx build \
            --platform "${PLATFORM}" \
            --file backend/Dockerfile \
            --tag "${image_base}:${unique_tag}" \
            --tag "${image_base}:${sha_tag}" \
            --tag "${image_base}:${latest_tag}" \
            --push \
            backend

          echo "image_uri=${image_uri}" >> "${GITHUB_OUTPUT}"
          echo "image_latest=${image_base}:${latest_tag}" >> "${GITHUB_OUTPUT}"
          echo "image_sha=${image_base}:${sha_tag}" >> "${GITHUB_OUTPUT}"

      - name: Deploy Cloud Run service
        env:
          IMAGE_URI: ${{ steps.image.outputs.image_uri }}
        run: |
          set -euo pipefail

          deploy_cmd=(
            gcloud run deploy "${SERVICE_NAME}"
            --project "${PROJECT_ID}"
            --region "${REGION}"
            --image "${IMAGE_URI}"
            --quiet
            --update-labels "managed_by=github-actions,component=backend,commit_sha=${GITHUB_SHA::7}"
          )

          if [[ "${ALLOW_UNAUTHENTICATED}" == "true" ]]; then
            deploy_cmd+=(--allow-unauthenticated)
          else
            deploy_cmd+=(--no-allow-unauthenticated)
          fi

          "${deploy_cmd[@]}"

      - name: Verify deploy
        env:
          IMAGE_URI: ${{ steps.image.outputs.image_uri }}
          IMAGE_LATEST: ${{ steps.image.outputs.image_latest }}
          IMAGE_SHA: ${{ steps.image.outputs.image_sha }}
        run: |
          set -euo pipefail
          service_url="$(
            gcloud run services describe "${SERVICE_NAME}" \
              --project "${PROJECT_ID}" \
              --region "${REGION}" \
              --format="value(status.url)"
          )"

          deployed_image="$(
            gcloud run services describe "${SERVICE_NAME}" \
              --project "${PROJECT_ID}" \
              --region "${REGION}" \
              --format="value(spec.template.spec.containers[0].image)"
          )"

          echo "Service URL: ${service_url}"
          echo "Expected image: ${IMAGE_URI}"
          echo "Pushed latest tag: ${IMAGE_LATEST}"
          echo "Pushed sha tag: ${IMAGE_SHA}"
          echo "Active image: ${deployed_image}"
